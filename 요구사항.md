# Ad Decision Gateway (ADG)
## 기능 정의서 (Functional Specification)
**Target Stack: Java 21 + Spring Boot 3.x**  
**Local-first: H2 기반으로 대부분 기능 로컬 실행 가능**  
**프로토콜: OpenRTB 2.x 스펙 기반 DSP(Demand-Side Platform) 개발**

---

## 1. 문서 목적
본 문서는 Ad Decision Gateway(ADG)의 기능 요구사항을 정의한다.  
ADG는 **OpenRTB(Open Real-Time Bidding) 2.x 스펙**을 기준으로 **DSP(수요측 플랫폼)** 역할을 수행하며, 다음을 포함한다.

- **광고 요청(Bid Request)** 수신·수집
- **광고 응답(Bid Response)** 생성·반환 및 수집
- **노출(Impression)·클릭(Click)·nurl/burl/lurl** 이벤트 수집 (URL 수신, 유효성·어뷰징·로깅)
- **광고(소재) 정보** 및 **매체(퍼블리셔/사이트/앱) 정보** 관리·저장
- 의존 서비스 병렬 호출, 정책/필터/스코어링, 비동기 이벤트 처리 (현재: 이벤트 큐 적재 + EventQueueDrainer 파일 기록)

---

## 2. 시스템 범위 및 구성요소
### 2.1 프로토콜 기준
- **OpenRTB 2.x** (권장: 2.5/2.6): IAB Tech Lab 실시간 입찰 API 스펙
- **Bid Request**: Exchange/SSP로부터 수신하는 광고 요청 (imp, site/app, device, user 등)
- **Bid Response**: DSP가 반환하는 입찰 응답 (seatbid, bid: impid, price, crid, adm/nurl 등)
- **Win Notice / Billing Notice**: 스펙상 선택 구현 (노출·클릭 수집으로 연계 가능)

### 2.2 구성요소
- **ADG API Server**: Bid(Decision) / Event / Admin API 제공
- **광고 요청·응답·노출·클릭** 수집 및 **광고 소재·매체** 테이블 저장
- **Mock Dependency Services** (로컬 실행 가능)
  - Profile, Campaign, Policy, Cap (OpenRTB 컨텍스트 활용)
- **비동기 이벤트**: 인메모리 이벤트 큐 적재 + EventQueueDrainer 주기 drain → 파일 기록 (확장 시 DB Outbox/Worker 도입 가능)
- **Storage**: H2 (기본), 광고·매체·이벤트 테이블 (아래 데이터 모델 참조)

---

## 3. 사용자/역할 정의
### 3.1 DSP 공개 API (Decision, Event)
- **인증 없음**. OpenRTB 스펙상 Exchange/SSP가 Bid Request 전송, Win/Click 등 URL 콜백 수신 시 별도 API Key 없이 동작.
- Decision: `POST /v1/decision` (Bid Request/Response)
- Event: `POST /v1/events/impression`, `/click`, `/nurl`, `/burl`, `/lurl` (URL 수신, 요청/응답 동일)

### 3.2 Admin (운영자)
- **인증 필수** (X-API-Key 또는 Admin Key). 정책·광고 소재·매체 설정 조회/수정, 시스템 상태·감사 로그 확인

---

## 4. 핵심 기능 목록 (Summary)
| 구분 | 기능 | 설명 |
|---|---|---|
| Bid Request | 광고 요청 수집 | OpenRTB Bid Request 수신·저장(bid_requests), 의사결정 입력으로 활용 |
| Bid Response | 광고 응답 수집 | OpenRTB Bid Response 생성·반환·저장(bid_responses), 소재(crid) 연계 |
| Decision | 실시간 의사결정 | downstream 병렬 호출 + 정책/필터/스코어링 → Bid 응답 생성 |
| Event | 노출/클릭/nurl/burl/lurl 이벤트 수집 | URL 수신 → 유효성검사 → 어뷰징 → 로깅, event_url_log 저장 |
| Creative/매체 | 광고·매체 정보 | creatives(소재), publishers/sites/apps(매체) 테이블 설계·관리 |
| Policy/Admin | 정책 관리 | 정책 조회/수정, feature flag, audit log |
| Resilience | 안정성 | timeout/retry/circuit/bulkhead/fallback |
| Observability | 관측성 | JSON 로그, 메트릭, health, tracing 연계 |
| Async | 이벤트 큐/drain | 이벤트 큐 적재, 주기 drain으로 파일 기록, 백로그(adg.eventQueue.size) 모니터링 |
| Docs | 문서화 | OpenAPI, ADR, Runbook, Mermaid |

---

## 5. API 기능 정의

### 5.1 Decision API (OpenRTB 2.x Bid Request/Response)
#### 5.1.1 의사결정 요청·응답 (OpenRTB 2.x)
- **Method/Path**: `POST /v1/decision`
- **Auth**: 없음 (OpenRTB 스펙; API Key/인가 미사용).
- **Request**: **OpenRTB 2.x Bid Request** (필수: `id`, `imp[]`; imp당 `id`, 선택 `banner.w/h`)
  - `id`: 요청 ID (requestId로 사용)
  - `imp[]`: imp.id(placementId), imp.banner.w/h(adSize)
  - `site` / `app`: site.id, app.id, publisher 등 (매체 정보)
  - `device`, `user`, `geo`: device/os/ifa/gaid, user.id, geo.country/region
  - `at`, `tmax`, `cur`, `wseat` 등 (선택)

- **Response**: **OpenRTB 2.x Bid Response**
  - `id`: BidRequest.id와 동일
  - `bidid`: 입찰 ID (decisionId)
  - `cur`: 통화
  - `seatbid[]`: seat, `bid[]` — `id`, `impid`, `price`, `adid`, **`crid`**(소재 ID), `nurl`, `adm`, `iurl`, `cid` 등  
  - Fallback 시: seatbid[0].bid[0].crid=house-default, adid=house 등으로 응답. (설정에 따라 503 반환 가능)

- **처리 흐름** (4단계 파이프라인: 요청 유효성 검증 → 광고 필터링 → 광고 선택 → 노출 준비)
  1. (선택) 수신 Bid Request를 bid_requests에 저장
  2. 입력 검증, traceId/requestId 전파
  3. 의존 서비스 병렬 호출 (Profile / Campaign / Policy / Cap)
  4. 요청 유효성 검증 → 광고 필터링 → 광고 선택 → 노출 준비
  5. decision_history 및 bid_responses 저장(확장 시), 이벤트 큐(decision-created) 적재 후 Bid Response 반환 (현재: 이벤트 큐 → Drainer가 파일 기록)

- **예외**
  - 400 (validation), 503 (전체 실패 시 fallback 반환 정책에 따라)

---

### 5.2 Event API (노출·클릭·nurl·burl·lurl)
- **Auth**: 없음 (OpenRTB DSP 공개 API).
- **Method/Path**: `POST /v1/events/impression`, `POST /v1/events/click`, `POST /v1/events/nurl`, `POST /v1/events/burl`, `POST /v1/events/lurl`
- **Request**: `{ "url": "https://..." }` (필수 url). OpenRTB Win Notice(nurl), Billing Notice(burl), Loss Notice(lurl) 등 URL 콜백 수신.
- **Response**: `{ "url": "https://..." }` (요청과 동일).
- **처리 흐름**: 유효성 검사(URL) → 어뷰징 적용 → 로깅(및 event_url_log 저장). 각 단계는 확장 가능(현재는 로깅 위주).
- **예외**: 400 (validation, 예: url 필수)

---

### 5.3 Admin / Policy API
- `GET /v1/admin/policies`, `POST /v1/admin/policies`: 정책 조회/업데이트, audit log, 정책 변경 시 이벤트 큐 적재

---

### 5.4 Health / Metrics
- `GET /actuator/health`, `GET /actuator/metrics`, `GET /actuator/prometheus`

---

## 6. 데이터 모델 (광고·매체·요청·응답·이벤트)

### 6.1 광고 요청 수집 (Bid Request)
- **bid_requests**
  - 수신한 OpenRTB Bid Request를 저장(로깅·분석·재연).
  - 필드 예: id, request_id(OpenRTB id), raw_json(CLOB), imp_ids, site_id, app_id, publisher_id, received_at

### 6.2 광고 응답 수집 (Bid Response)
- **bid_responses**
  - DSP가 반환한 Bid Response 요약 저장.
  - 필드 예: id, request_id, bid_response_id, seat, impid, price, crid, adid, raw_json, responded_at

### 6.3 이벤트 URL 로그
- **event_url_log**
  - id(PK), event_type(impression/click/nurl/burl/lurl), url, created_at. URL 수신 이벤트 로깅용.
- **events** (레거시, 선택 유지)
  - 기존 event_id, decision_id, client_id, event_type 등. 신규 흐름은 event_url_log 사용.

### 6.4 광고(소재) 정보
- **creatives**
  - 소재(Creative) 마스터: crid, campaign_id, name, format(banner/video/native/audio), width, height, mime_type, adm_snippet, landing_url, status, created_at, updated_at

### 6.5 매체 정보
- **publishers**
  - 퍼블리셔: publisher_id(OpenRTB publisher.id), name, domain, ext_json, created_at, updated_at
- **sites**
  - 사이트: site_id, publisher_id(FK), name, domain, page, ref, ext_json, created_at, updated_at
- **apps**
  - 앱: app_id, publisher_id(FK), name, bundle, domain, storeurl, ver, created_at, updated_at

(기존 decision_history, policies, audit_log 유지. 이벤트·이력은 현재 이벤트 큐→파일 기록.)

---

## 7. Mock Dependency 기능 정의
- Profile / Campaign / Policy / Cap Mock: 지연·실패·timeout 시뮬레이션 (delayMs, failRate, forceTimeout)
- Campaign Mock 응답에 **캠페인·소재(crid)** 정보 포함 권장

---

## 8. 비동기 처리 (이벤트 큐 / 확장 시 Outbox·Worker)
- **현재 구현**: Decision 생성, 이벤트 수집, 정책 변경 시 EventQueuePort(이벤트 큐)에 적재. EventQueueDrainer가 주기 drain하여 파일(NDJSON) 기록. 패키지: shared.adapter.eventqueue.
- **확장 시**: DB outbox 테이블 적재, Worker가 PENDING 조회 → 처리 → SENT/FAILED, 재시도(backoff), maxRetry (ADR 001 참고).

---

## 9. 기능 완료 기준 (Functional DoD)
- OpenRTB 스타일 **광고 요청 수집** (bid_requests) 및 **광고 응답 수집** (bid_responses)
- `/v1/decision` 정상 응답 (OpenRTB Bid Response; seatbid[0].bid[0]에 **crid**, adid, price 등 포함)
- **노출·클릭·nurl·burl·lurl** 이벤트 URL 로깅 (event_url_log)
- **광고 소재(creatives)·매체(publishers/sites/apps)** 테이블 설계 및 저장/조회 가능
- 이벤트 큐 drain(파일 기록) 동작, admin 정책·audit log

---

# Ad Decision Gateway (ADG)
## 비기능 정의서 (Non-Functional Specification)

*(이하 기존과 동일: 성능, Resilience, 일관성, 보안, 로깅, 관측성, 유지보수, 테스트, Runbook 등 요구사항 유지.)*

---

## 1. 성능 요구사항
- Avg < 50ms, P95 < 100ms (로컬 기준)
- 최소 200 rps 부하 스크립트, 5k RPS 목표 설정 가능
- **광고/소재 등 DB 조회 시 로컬 캐시(예: Caffeine) 적용**으로 조회 성능 고려

---

## 2. 안정성/복원력
- Timeout, Retry, Circuit Breaker, Bulkhead, Fallback

---

## 3. 일관성/내구성
- 이벤트 저장 후 처리(at-least-once). 현재: 이벤트 큐→파일 drain. 확장 시 Outbox·idempotency.

---

## 4. 보안
- **DSP 공개 API(Decision, Event)**: 인증 없음. **Admin API**: API Key/Admin Key 필수. Bean Validation, 민감정보 마스킹

---

## 5. 로깅
- Structured JSON, traceId/requestId/decisionId/crid, 샘플링·throttling, audit log

---

## 6. 관측성
- RED 메트릭, dependency·retry·fallback·이벤트 큐(adg.eventQueue.size) 메트릭, health

---

## 7. 유지보수/확장성
- Port/Adapter, 모듈 경계, OpenRTB 확장(ext) 수용
- Decision 처리는 4단계 파이프라인(검증·필터·선택·노출)으로 확장 가능하게 구성

---

## 8. 테스트
- Unit/Slice/Integration, 장애 시나리오(fallback, 이벤트 큐 drain)

---

## 9. Runbook
- SLO/SLA, 알람 기준, 재시작/복구, 로그/메트릭 가이드

---

# Ad Decision Gateway (ADG)
## 기술 스택 정의서 (Tech Stack)

*(기존과 동일: Java 21, Spring Boot 3.x, Gradle, Spring Web, OpenAPI, JPA, H2, Flyway, Resilience4j, Actuator, Micrometer, Logback, Virtual Threads 등.)*

- **프로토콜**: OpenRTB 2.x 스펙 참조 (Bid Request/Response 객체 구조)
- **문서**: IAB Tech Lab OpenRTB 2.x, AdCOM(열거형 등)
